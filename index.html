<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="favicon.svg">
    <title>14-Segment Control</title>
    <!-- Load Blockly core -->
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <!-- Load the default blocks -->
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <!-- Load generators -->
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly/python_compressed.js"></script>
    <!-- Load a message file -->
    <script src="https://unpkg.com/blockly/msg/en.js"></script>    <!-- Load Blockly core -->
    <!--    MQTT CLIENT-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
            type="text/javascript"></script>

    <script src="led14_segment_blocks.js"></script>
    <script src="toolbox.js"></script>
    <script src="led_control.js"></script>
    <script src="comm.js"></script>
    <script src="examples.js"></script>
    <style>
        #indicatorsDiv {
            position: absolute;
            right: 5cqw;
            top: 5cqh;

            > div {
                background-color: #f8f8f8;
                border: darkslategrey 3px dashed;
                border-radius: 1cqw;
                padding: 2cqh;
                display: flex;
                align-items: center;
                user-select: none;
            }
            #connectDiv {
                grid-gap: 0.6cqw;
                align-items: start;
                 *:last-child {
                    margin-left: auto;
                }
            }
            img, embed {
                height: 3cqmax;
                width: 3cqmax;
            }
        }


        #displayDiv embed {
            height: 12cqh;
            width: 7cqw;
            user-select: none;
            pointer-events: none;
        }

        #settings-board img {
            height: 1.5cqmax;
            width: 1.5cqmax;
        }

        /*noinspection CssUnusedSymbol*/
        .LoadButton .blocklyFlyoutButtonBackground {
            fill: #236123;
        }

        /*noinspection CssUnusedSymbol*/
        .SaveButton .blocklyFlyoutButtonBackground {
            fill: #682714;
        }
    </style>
</head>
<body>
<div id="blocklyDiv" style="height: 95cqh; width: 95cqw;"></div>
<div id="indicatorsDiv">
    <div id="displayDiv">
        <button id="restart" title="Restart">
            <img src="restart-svgrepo-com.svg">
        </button>
        <embed type="image/svg+xml" id="digit0">
        <embed type="image/svg+xml" id="digit1">
        <embed type="image/svg+xml" id="digit2">
        <embed type="image/svg+xml" id="digit3">
    </div>
    <div id="connectDiv">
        <svg id="connect-indicator" width="3cqmax" height="3cqmax" viewBox="0 0 32 32" fill="none">
            <title>Connecting</title>
            <g>
                <path  d="M15.631,24.833l-3.649-3.717c-0.194-0.197-0.201-0.527,0.005-0.712C13.04,19.456,14.448,19,16,19
		s2.96,0.456,4.014,1.405c0.206,0.185,0.198,0.514,0.005,0.712l-3.649,3.717C16.173,25.056,15.827,25.056,15.631,24.833z M16,13
		c-3.06,0-5.845,1.074-7.944,2.982c-0.198,0.18-0.208,0.491-0.031,0.691l1.958,2.219c0.186,0.21,0.502,0.216,0.709,0.026
		C12.093,17.635,13.955,17,16,17c2.045,0,3.907,0.635,5.309,1.918c0.207,0.189,0.523,0.184,0.709-0.026l1.958-2.219
		c0.177-0.2,0.167-0.511-0.031-0.691C21.845,14.074,19.06,13,16,13z M4.125,12.253l1.953,2.213c0.182,0.206,0.492,0.218,0.697,0.033
		C9.22,12.291,12.453,11,16,11s6.78,1.291,9.225,3.5c0.204,0.184,0.515,0.173,0.697-0.033l1.953-2.213
		c0.179-0.203,0.166-0.518-0.035-0.699C24.7,8.729,20.556,7,16,7c-4.556,0-8.7,1.729-11.839,4.554
		C3.96,11.735,3.946,12.05,4.125,12.253z"/>
            </g>
        </svg>
        <button id="upload-board" title="Upload to Board">
            <img src="upload-svgrepo-com.svg" alt="Upload to Board">
        </button>
        <button id="restart-board" title="Restart on Board">
            <img src="restart-svgrepo-com.svg" alt="Restart on Board">
        </button>
        <button id="settings-board" title="Connection settings">
            <img src="settings-cog-svgrepo-com.svg" alt="Connection settings">
        </button>
    </div>
</div>
</body>
<script>
    const config = {
        grid:
            {
                spacing: 20,
                length: 3,
                colour: "#ccc",
                snap: true
            },
        oneBasedIndex: false,
        sounds: false,
        toolbox: toolbox,
        zoom: {controls: true}

    };
    const workspace = Blockly.inject("blocklyDiv", config);
    const CHANGE_EVENTS = new Set([Blockly.Events.BLOCK_CHANGE, Blockly.Events.BLOCK_CREATE, Blockly.Events.BLOCK_DELETE, Blockly.Events.BLOCK_MOVE])
    workspace.addChangeListener(function (event) {
            if (CHANGE_EVENTS.has(event.type)) {
                window.workspace_changed = true
                segm14StartScript()
            }
        }
    )
    //todo display stuff led
    document.getElementById("digit0").src = led14Svg
    document.getElementById("digit1").src = led14Svg
    document.getElementById("digit2").src = led14Svg
    document.getElementById("digit3").src = led14Svg
    workspace.registerButtonCallback("file-load", function (button) {
        const js = window.localStorage.getItem(`local-file:${button.info.file_key}`)
        if (js != null) {
            if (window.workspace_changed && confirm(`Unsaved workspace, load file ${button.info.file_key} anyway?`)) {
                Blockly.serialization.workspaces.load(JSON.parse(js), workspace);
                window.workspace_changed = false
            }
        } else {
            alert(`Nothing saved to file ${button.info.file_key}`)
        }

    })
    workspace.registerButtonCallback("file-save", function (button) {
        if (confirm(`Save to file ${button.info.file_key}?`)) {
            const js = JSON.stringify(Blockly.serialization.workspaces.save(workspace));
            window.localStorage.setItem(`local-file:${button.info.file_key}`, js)
            window.workspace_changed = false
        }
    })
    EXAMPLES.init(workspace)

    {
        const QUICKSAVE_KEY = "local-file:quicksave"
        const js = window.localStorage.getItem(QUICKSAVE_KEY)
        if (js != null) {
            setTimeout(() => {
                try {
                    Blockly.serialization.workspaces.load(JSON.parse(js), workspace);
                } catch (e) {
                    console.warn(e)
                }
            }, 100)
        }
        setInterval(() => {
            try {
                const js = JSON.stringify(Blockly.serialization.workspaces.save(workspace));
                window.localStorage.setItem(QUICKSAVE_KEY, js)
                console.info("Quick save")
            } catch (e) {
                console.warn(e)
            }
        }, 30000)
    }
    MqttClient.start()

    document.getElementById("restart").addEventListener("click", function () {
        segm14StartScript()
    });

    document.getElementById("upload-board").addEventListener("click", function () {
        const js = python.pythonGenerator.workspaceToCode(workspace)
        console.log(js)
        MqttClient.executePython(js)
    });

    document.getElementById("restart-board").addEventListener("click", function () {
        MqttClient.restartPython()
    });

    document.getElementById("settings-board").addEventListener("click", function () {
        const s = window.prompt("Please enter communication MQTT_TOKEN from secrets.py", MqttClient.mqttToken)
        if(s !== null) {
            window.localStorage.setItem("MQTT_TOKEN", s)
            window.location.reload()
        }

    });


</script>

</html>